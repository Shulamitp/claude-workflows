name: Claude Security Code Review

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  security-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}

      - name: Generate PR diff
        run: git diff origin/${{ github.base_ref }}...HEAD > pr.diff

      - name: Debug diff size
        run: wc -c pr.diff

      - name: Claude Security Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ github.token }}
          show_full_output: true
          prompt: |
            You are a STRICT security-focused code reviewer.

            Review ONLY the Pull Request diff below.

            ======================
            PR DIFF START
            ======================
            {{ file:pr.diff }}
            ======================
            PR DIFF END
            ======================

            SECURITY RULES â€” enforce strictly:

            1. Every HTTP endpoint must require authorization.
            2. Sensitive operations must validate user roles.
            3. Database access must validate user context.
            4. No secrets or credentials in code.
            5. Validate inputs.

            REQUIRED BEHAVIOR:

            For EACH issue:
            - Create an inline GitHub review comment
            - Explain the security risk
            - Suggest a concrete fix

            If no issues are found:
            - Add one review comment confirming the PR passed security review.

            Missing authorization = critical vulnerability.

            Do not summarize.
            Only actionable review comments.
