# Fallback: Direct API call if action fails or doesn't complete
      - name: Fallback - Direct API Review
        if: steps.claude_action.outcome != 'success'
        id: direct_review
        uses: actions/github-script@v7
        env:
          CLAUDE_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        with:
          script: |
            const { execSync } = require('child_process');
            
            console.log('Running fallback - Direct API review');
            
            try {
              const diff = execSync('git diff origin/${{ github.base_ref }}...${{ github.head_ref }}', {
                maxBuffer: 1024 * 1024 * 10
              }).toString();
              
              console.log('Diff size: ' + diff.length + ' characters');
              
              const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-api-key': process.env.CLAUDE_TOKEN,
                  'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                  model: 'claude-sonnet-4-5-20250929',
                  max_tokens: 4000,
                  messages: [{
                    role: 'user',
                    content: 'You are a security-focused code reviewer.\n\nReview this Pull Request diff and identify ALL security issues.\n\nFocus on:\n1. Missing [Authorize] attributes on HTTP endpoints\n2. Missing user role validation\n3. Missing user context validation before data access\n\nFor each issue found, provide:\n- The file and line where the issue is located\n- Clear explanation of the security risk\n- Specific recommendation to fix it\n\nHere is the diff:\n\n```diff\n' + diff.substring(0, 45000) + '\n```\n\nFormat your response as a structured security review.'
                  }]
                })
              });
              
              const data = await response.json();
              
              if (!response.ok) {
                console.error('API Error:', JSON.stringify(data, null, 2));
                core.setFailed('Claude API Error: ' + (data.error && data.error.message || 'Unknown error'));
                return;
              }
              
              const review = data.content[0].text;
              console.log('Review received from Claude');
              
              const inputTokens = data.usage && data.usage.input_tokens || 0;
              const outputTokens = data.usage && data.usage.output_tokens || 0;
              const cost = (inputTokens * 0.000003 + outputTokens * 0.000015).toFixed(4);
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '## Claude Security Review\n\n' + review + '\n\n---\n\n*Note: Review performed via direct API (fallback mode)*\n*Cost: ~$' + cost + '*'
              });
              
              console.log('Review comment posted successfully');
              
            } catch (error) {
              console.error('Fallback failed:', error);
              core.setFailed('Fallback review failed: ' + error.message);
            }