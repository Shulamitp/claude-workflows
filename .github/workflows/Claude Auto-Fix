name: Claude Auto-Fix

on:
  issues:
    types: [labeled]

jobs:
  auto-fix:
    if: contains(github.event.issue.labels.*.name, 'auto-fix')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Configure Claude Code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude-code config set api-key "$ANTHROPIC_API_KEY"

      - name: Run Claude Code Fix
        run: |
          cat > /tmp/prompt.txt << 'EOF'
          Fix the bug in src/Program.cs
          
          Bug description:
          ${{ github.event.issue.body }}
          
          Instructions:
          1. Find src/Program.cs
          2. Make the requested change
          3. Follow existing code style
          4. Only change what's requested
          5. Commit with message: "fix: ${{ github.event.issue.title }}"
          EOF
          
          claude-code --prompt "$(cat /tmp/prompt.txt)" --verbose

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix: ${{ github.event.issue.title }}'
          branch: 'auto-fix/issue-${{ github.event.issue.number }}'
          delete-branch: true
          title: 'ðŸ¤– Auto-fix: ${{ github.event.issue.title }}'
          body: |
            ## Automated Fix by Claude Code
            
            Fixes #${{ github.event.issue.number }}
            
            This PR was automatically generated by Claude Code.
            Please review the changes before merging.
          labels: automated-fix
